<script>
  Vue.component('v-select', VueSelect.VueSelect)

  let indApp = new Vue({
    el: '.expenses',
    data: <%= fill_vue_data(nil, { 
      sortKey: 'date',
      reverse: false,
      query: '',
      query_field: '',
      filteredData: [],
      list_values: 'shop account expense_type',
      lists: 'shops accounts expense_types users expenses:raw@json_expenses',
      columns: [['date', 'Дата'], 
      ['shop', 'Магазин'], ['amount', 'Сумма'],  
      ['account', 'Счет'], ['expense_type', 'Категория'], ['user', 'Кто'], ['comment', 'Комментарий']]
      
    }) %>,

    updated(){
      this.onInput();
    },

    mounted(){
      this.$root.$on('onInput', this.onInput);
    },


    computed: {
     calcTotal: function () { 

      total = 0;
      for (i = 0; i < this.filteredData.length; ++i) {
        total = total + this.filteredData[i].amount;
      }
      return to_sum(total);
    },

    computedList: function () {
      var vm = this
      this.filteredData = this.expenses.sort((a,b) => 
        (a[this.sortKey] > b[this.sortKey]) ? 1 : ((b[this.sortKey] > a[this.sortKey]) ? -1 : 0));

      if (this.query_field !== '' && this.query !== undefined){
        this.filteredData = this.filteredData.filter(function (item) {
          // console.log('item', item, vm.query_field)
          return item[vm.query_field].toLowerCase().indexOf(vm.query.toLowerCase()) !== -1
        })
      }else{
        return this.filteredData;
      }
      return this.filteredData;
    },
  },

  methods:{
    onInput(e){
      if (e !== undefined){
        // console.log('e', e);
        this.query_field = e.name;
        this.query = e.label;
      }
    },

    sortBy: function(sortKey) {
      this.reverse = (this.sortKey == sortKey) ? ! this.reverse : false;
      this.sortKey = sortKey;
    },

    shuffle: function () {
      this.sortBy("date")
      this.query_field = '';
    },

    editLink(id){
      return "/expenses/" + id + "/edit"
    },

    deleteLink(id){
      return "/expenses/" + id 
    }


  }

})


</script>